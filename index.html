
<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
<head prefix="og: http://ogp.me/ns#">
    <meta charset="utf-8" />
    <title itemprop="name"></title>
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="" />
    <style>
	html
	{
		position: relative;
		min-height: 100%;
		-ms-touch-action: manipulation;
		touch-action: manipulation;
	}

	body
	{
		margin: 0 auto 70px auto;
		padding: 0;
		color: #444;
		background-color: #fff;
		font: 11.4285714286px "trebuchet ms", palatino, tahoma, sans-serif;
	}
	/* The Modal (background) */
	.modal
	{
		display: none; /* Hidden by default */
		position: fixed; /* Stay in place */
		z-index: 1; /* Sit on top */
		left: 0;
		top: 0;
		width: 100%; /* Full width */
		height: 100%; /* Full height */
		overflow: auto; /* Enable scroll if needed */
		background-color: rgb(0,0,0); /* Fallback color */
		background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}

	/* Modal Content/Box */
	.modal-content
	{
		background-color: #fefefe;
		margin: 5% auto; /* 15% from the top and centered */
		padding: 20px;
		border: 1px solid #888;
		width: 90%; /* Could be more or less, depending on screen size */
		/*height: 80%;*/
	}

	/* The Close Button */
	.close
	{
		color: #aaa;
		float: right;
		font-size: 28px;
		font-weight: bold;
	}

	.close:hover,
	.close:focus
	{
		color: black;
		text-decoration: none;
		cursor: pointer;
	}

</style>

</head>
<body>
<div id="ConnectWithGoolePhotos">
        butt File(s):
        <div>
            <input id="btnGetGoolePhotos" type='button' value="Select from Google Photos" onclick="" style="display:none;" />
            <input id="btnConnectWithGoolePhotos" type='button' value="Connect to Google Photos" onclick="" style="display:none;" />
            <input id="btnGoolePhotosRevoke" type='button' value="Disconnect from Google Photos" onclick="" style="display:none;" />
            <div>
                <label id="ConnectWithGoolePhotosError"></label>
            </div>
        </div>
</div>

<!-- The Modal -->
<div id="googlePhotosModal" class="modal">

    <!-- Modal content -->
    <div class="modal-content">
        <span id="modalClose" class="close">&times;</span>
        <div>
            <p>Here is the header!</p>
        </div>
        <div id="googlePhotosModalContent" class="row"> @{/*style = "position:absolute;height:80%;width:100%;overflow-y:scroll;" >*/} 
            Please standby, loading from Google Photos...
        </div>
    </div>

</div>

<script async defer src="https://apis.google.com/js/api.js"
		onload="this.onload=function(){};handleClientLoad()"
		onreadystatechange="if (this.readyState === 'complete') this.onload()">
</script>

<script>

	var googlePhotosModal = document.getElementById("googlePhotosModal");
	var googlePhotosModalClose = document.getElementById("modalClose");
	// When the user clicks on <span> (x), close the modal
	googlePhotosModalClose.onclick = function ()
	{
		googlePhotosModal.style.display = "none";
	}

	// When the user clicks anywhere outside of the modal, close it
	window.onclick = function (event)
	{
		if (event.target == googlePhotosModal)
		{
			googlePhotosModal.style.display = "none";
		}
	}

	var GoogleAuth;
	var SCOPE = 'https://www.googleapis.com/auth/photoslibrary.readonly';
	var lastPageToken = "";
	var doneLoading = false;

	function handleClientLoad()
	{
		// Load the API's client and auth2 modules.
		// Call the initClient function after the modules load.
		gapi.load('client:auth2', initClient);
	}

	function initClient()
	{
		// Retrieve the discovery document for version 3 of Google Drive API.
		// In practice, your app can retrieve one or more discovery documents.
		var discoveryUrl = 'https://www.googleapis.com/discovery/v1/apis/photos/v1/rest';
		discoveryUrl = "https://www.googleapis.com/discovery";

		// Initialize the gapi.client object, which app uses to make API requests.
		// Get API key and client ID from API Console.
		// 'scope' field specifies space-delimited list of access scopes.
		gapi.client.init({
			//'discoveryDocs': [discoveryUrl],
			'clientId': '800930803004-blhvr2c0u8rpikjpeav7famjm77s32l6.apps.googleusercontent.com',
			'scope': SCOPE
		}).then(
		// success
		function ()
		{
			GoogleAuth = gapi.auth2.getAuthInstance();

			// Listen for sign-in state changes.
			GoogleAuth.isSignedIn.listen(updateSigninStatus);

			// Handle initial sign-in state. (Determine if user is already signed in.)
			var user = GoogleAuth.currentUser.get();
			setSigninStatus();

			// Call handleAuthClick function when user clicks on
			//      "Sign In/Authorize" button.
			$('#btnConnectWithGoolePhotos').click(function ()
			{
				handleAuthClick();
			});
			$('#btnConnectWithGoolePhotos').css('display', '');
			$('#btnGoolePhotosRevoke').click(function ()
			{
				revokeAccess();
			});
			$('#btnGetGoolePhotos').click(function ()
			{
				googlePhotosModal.style.display = "block";
				GetGooglePhotos(lastPageToken);
			});
		},
		// failure
		function (error)
		{
			document.getElementById('ConnectWithGoolePhotosError').innerHTML = "gapi.client.init: " + error.details;
			setTimeout(function ()
			{
				document.getElementById('ConnectWithGoolePhotosError').style.display = 'none';
				document.getElementById('ConnectWithGoolePhotos').style.display = 'none';

			}, 5000);
		});
	}

	function handleAuthClick()
	{
		if (GoogleAuth.isSignedIn.get())
		{
			// User is authorized and has clicked 'Sign out' button.
			GoogleAuth.signOut();
		} else
		{
			// User is not signed in. Start Google auth flow.
			GoogleAuth.signIn();
		}
	}

	function revokeAccess()
	{
		GoogleAuth.disconnect();
	}

	function setSigninStatus(isSignedIn)
	{
		var user = GoogleAuth.currentUser.get();
		var isAuthorized = user.hasGrantedScopes(SCOPE);
		if (isAuthorized)
		{
			$('#btnConnectWithGoolePhotos').val('Sign out of Google Photos');
			$('#btnGoolePhotosRevoke').css('display', 'inline-block');
			$('#btnGetGoolePhotos').css('display', '');
			$('#ConnectWithGoolePhotosError').html('You are currently signed in and have granted ' +
				'access to this app.');
		}
		else
		{
			$('#btnConnectWithGoolePhotos').val('Connect to Google Photos');
			$('#btnGoolePhotosRevoke').css('display', 'none');
			$('#btnGetGoolePhotos').css('display', 'none');
			$('#ConnectWithGoolePhotosError').html('You have not authorized this app or you are ' +
				'signed out.');
		}
	}

	function updateSigninStatus(isSignedIn)
	{
		setSigninStatus();
	}

	function GetGooglePhotos(nextPageToken)
	{
		var user = GoogleAuth.currentUser.get();
		var isAuthorized = user.hasGrantedScopes(SCOPE);
		if (isAuthorized && !doneLoading)
		{
			var parameters = { 'pageSize': '100' };
			if (nextPageToken != null && nextPageToken != "")
			{
				parameters = { 'pageToken': nextPageToken, 'pageSize': '100' };
			}
			$('#btnGetGoolePhotos').prop('disabled', true);
			gapi.client.request(
				{
					'path': 'https://photoslibrary.googleapis.com/v1/mediaItems',
					'method': 'GET',
					'params': parameters
				}).then(function (response)
				{
					var items = JSON.parse(response.body);
					PostPhotosToModal(items.mediaItems);

					if (items.nextPageToken != null && items.nextPageToken != "")
					{
						lastPageToken = items.nextPageToken;
					}
					else
					{
						doneLoading = true;
					}

					if (items.nextPageToken != null && items.nextPageToken != "" &&
						googlePhotosModal.style.display != "none")
					{
						GetGooglePhotos(items.nextPageToken);
					}
					else
					{
						$('#btnGetGoolePhotos').prop('disabled', false);
					}
				},
				function (reason)
				{
					$('#btnGetGoolePhotos').prop('disabled', false);
					document.getElementById('ConnectWithGoolePhotosError').innerHTML = "gapi.client.request: " + reason.status + ": " + reason.statusText;
				});
		}
	}

	function PostPhotosToModal(mediaItems)
	{
		if (googlePhotosModal.style.display != "none")
		{
			if (lastPageToken == '')
			{
				// first time
				$("#googlePhotosModalContent").html('');
			}

			var newHtml = "";

			for (var i = 0; i < mediaItems.length; i++)
			{
				newHtml += '<div class="col"><img src="' + mediaItems[i].baseUrl + '" style="max-width: 200px; max-height: 200px;" /></div>';
			}

			$("#googlePhotosModalContent").append(newHtml);
		}
	}

</script>

</body>
</html>